<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Harvey's Decision Engine | SWIPE-OS v5.2 (Dynamic Ticket)</title>
    <style>
        /* =========================================
           CORE SYSTEM
           ========================================= */
        :root {
            --brand-orange: #ff671f;
            --brand-bg: #0a0a0a;
            --text-main: #f0f0f0;
            --accent-go: #00e676; 
            --font-tech: 'Courier New', monospace;
            --font-ui: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        html, body {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--brand-bg);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
        }

        #master-container {
            height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
        }

        .main-slide {
            height: 100vh;
            width: 100vw;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            background: var(--brand-bg);
            transition: transform 0.6s cubic-bezier(0.19, 1, 0.22, 1);
            will-change: transform;
        }

        .main-slide.prev { transform: translateY(-100%); }
        .main-slide.active { transform: translateY(0); z-index: 10; }
        .main-slide.next { transform: translateY(100%); z-index: 20; }

        .slide-header {
            padding: 20px;
            border-left: 3px solid var(--brand-orange);
            height: 70px;
            flex-shrink: 0;
            z-index: 10;
            display: flex;
            align-items: center;
            transition: opacity 0.3s;
        }
        
        .main-slide.deck-active .slide-header { opacity: 0.2; }
        .main-slide.deck-active { background: #000; }

        .header-title {
            font-family: var(--font-tech);
            font-size: 0.75rem;
            color: var(--brand-orange);
            letter-spacing: 1px;
            font-weight: 700;
            text-transform: uppercase;
        }

        /* =========================================
           CONTENT DECK
           ========================================= */
        .carousel-viewport {
            position: relative;
            flex-grow: 1;
            width: 100%;
            touch-action: none;
        }

        .sub-slide {
            position: absolute;
            inset: 0;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transform: translateY(0) scale(1);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.3s ease;
        }

        .sub-slide.layer-1 { z-index: 30; opacity: 1; pointer-events: auto; }
        .sub-slide.layer-2 { z-index: 20; }
        .sub-slide.layer-3 { z-index: 10; }
        .sub-slide.opt-active { z-index: 30; opacity: 1; pointer-events: auto; transform: translateX(0); }
        .sub-slide.opt-hidden { z-index: 0; opacity: 0; pointer-events: none; }

        h1 { font-size: 1.8rem; margin: 0 0 15px 0; line-height: 1; letter-spacing: -1px; color: var(--brand-orange); }
        .primary-question { font-size: 1.1rem; color: #fff; margin-bottom: 25px; line-height: 1.4; font-weight: 600; }
        .content-text { font-size: 0.9rem; color: #aaa; line-height: 1.6; max-height: 40vh; overflow-y: auto; }

        .item-list { list-style: none; padding: 0; margin-top: 10px; }
        .item-list li { padding: 6px 0; border-bottom: 1px solid #222; font-size: 0.85rem; color: #ccc; }
        .item-list li:before { content: "• "; color: var(--brand-orange); }

        .role-label {
            font-family: var(--font-tech);
            font-size: 0.6rem;
            color: #000;
            background: var(--accent-go);
            padding: 4px 8px;
            border-radius: 4px;
            width: fit-content;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .nav-hint {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #333;
            font-family: var(--font-tech);
            font-size: 0.7rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .ascii-box {
            background: #080808;
            border: 1px solid #333;
            color: var(--accent-go);
            font-family: var(--font-tech);
            font-size: 0.75rem;
            padding: 15px;
            border-radius: 6px;
            white-space: pre;
            line-height: 1.2;
            margin-top: 20px;
        }

        /* =========================================
           VERDICT & BRAND REDESIGN
           ========================================= */
        .verdict-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: center;
        }

        .choice-header {
            font-family: var(--font-tech);
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
        }

        .input-group {
            border: 1px solid #333;
            background: #111;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 40px;
            min-height: 60px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #333;
            padding: 10px 0;
            font-family: var(--font-tech);
            font-size: 0.8rem;
        }
        .input-row:last-child { border-bottom: none; }
        
        .input-key { color: #888; text-transform: uppercase; }
        .input-val { color: var(--accent-go); font-weight: bold; text-align: right; }

        .hero-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .hero-burger {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            text-transform: uppercase;
            color: #fff;
            margin-bottom: 5px;
            letter-spacing: -2px;
        }
        
        .hero-sub {
            font-family: var(--font-tech);
            color: var(--brand-orange);
            font-size: 0.8rem;
            letter-spacing: 2px;
        }

        /* Slide 13 Logo Placeholder */
        .brand-logo-placeholder {
            width: 80px;
            height: 80px;
            background: #222;
            border-radius: 50%;
            margin: 0 auto 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--brand-orange);
            color: var(--brand-orange);
            font-weight: 900;
            font-size: 1.5rem;
        }

        .final-actions {
            display: grid;
            gap: 12px;
            margin-top: auto;
        }
        .btn {
            background: #222;
            color: #fff;
            border: 1px solid #333;
            padding: 18px;
            width: 100%;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.98); }
        
        .btn-wa { background: #25D366; color: #000; border: none; }
        .btn-support { background: transparent; border: 1px solid #444; color: #888; }
        .btn-share { background: var(--brand-orange); color: #fff; border: none; }
        .btn-insta { 
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            color: white; border: none;
        }

        #depth-fill {
            position: fixed; right: 0; top: 0; bottom: 0; width: 4px;
            background: #333; z-index: 900;
            height: 0%; transition: height 0.05s linear, background 0.3s;
        }

        /* Toast for copy feedback */
        .toast-msg {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #222; color: #00e676; padding: 12px 24px;
            border: 1px solid #00e676;
            border-radius: 30px; font-size: 0.8rem; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; z-index: 1000; font-family: var(--font-tech);
            white-space: nowrap;
        }
        .toast-msg.visible { opacity: 1; }

        /* =========================================
           LISTEN MODE UI
           ========================================= */
        #mic-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: #111;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #444;
            z-index: 2000;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #mic-toggle svg { width: 28px; height: 28px; fill: #666; transition: fill 0.3s; }
        
        #mic-toggle.listening {
            border-color: var(--accent-go);
            background: rgba(0, 230, 118, 0.15);
            animation: pulse-mic 1.5s infinite;
        }
        #mic-toggle.listening svg { fill: var(--accent-go); }

        @keyframes pulse-mic {
            0% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0.4); }
            70% { box-shadow: 0 0 0 15px rgba(0, 230, 118, 0); }
            100% { box-shadow: 0 0 0 0 rgba(0, 230, 118, 0); }
        }

        #voice-feedback {
            position: fixed;
            bottom: 30px;
            left: 90px;
            font-family: var(--font-tech);
            font-size: 0.8rem;
            color: #fff;
            background: rgba(0,0,0,0.7);
            padding: 8px 12px;
            border-radius: 4px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 1000;
            border-left: 2px solid var(--accent-go);
        }
        #voice-feedback.visible { opacity: 1; }

    </style>
</head>
<body>

<div id="master-container"></div>
<div id="depth-fill"></div>
<div id="toast" class="toast-msg">ACTION CONFIRMED</div>

<div id="mic-toggle" onclick="toggleListenMode()">
    <svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/></svg>
</div>
<div id="voice-feedback">LISTENING...</div>

<script>
    /* =========================================
       CONFIG: HARVEY'S 2026 MENU
       ========================================= */
    const CONFIG = {
      "version": "HARVEYS_MENU_2026_V1",
      "slides": [
        {
          "id": "burger",
          "type": "selector",
          "title": "01 / 13 · FLAME-GRILLED BURGERS",
          "key": "burger",
          "options": {
            "ORIGINAL": { "items": ["Original"], "tag": "NOSTALGIA", "voice": ["original", "classic"] },
            "ANGUS": { "items": ["Angus"], "tag": "QUALITY", "voice": ["angus", "premium", "beef"] },
            "VEGGIE": { "items": ["Veggie"], "tag": "PLANT", "voice": ["veggie", "plant", "vegetarian"] }
          }
        },
        {
          "id": "chicken",
          "type": "selector",
          "title": "02 / 13 · CHICKEN & WRAPS",
          "key": "chicken",
          "options": {
            "CRISPY": { "items": ["Crispy"], "tag": "TEXTURE", "voice": ["crispy", "fried"] },
            "GRILLED": { "items": ["Grilled"], "tag": "HEALTH", "voice": ["grilled", "healthy"] },
            "BUFFALO": { "items": ["Buffalo"], "tag": "SPICY", "voice": ["buffalo", "spicy"] }
          }
        },
        {
          "id": "sides",
          "type": "selector",
          "title": "03 / 13 · SIDES & POUTINES",
          "key": "side",
          "options": {
            "POUTINE": { "items": ["Classic Poutine"], "tag": "COMFORT", "voice": ["poutine", "gravy"] },
            "SIDES": { "items": ["Frings", "Fries"], "tag": "CLASSIC", "voice": ["sides", "fries", "rings", "frings", "pickles"] }
          }
        },
        {
          "id": "value",
          "type": "selector",
          "title": "04 / 13 · VALUE PICKS",
          "key": "value",
          "options": {
            "JR_BURGERS": { "items": ["Jr. Burger"], "tag": "BUDGET", "voice": ["junior", "jr", "budget"] },
            "JR_CHICKEN": { "items": ["Jr. Crispy"], "tag": "SNACK", "voice": ["junior chicken", "chicken snack"] },
            "SNACKS": { "items": ["Nuggets"], "tag": "QUICK", "voice": ["snacks", "nuggets"] },
            "DESSERTS": { "items": ["Donuts"], "tag": "SWEET", "voice": ["dessert", "donut", "pie", "sweet"] }
          }
        },
        {
          "id": "drinks",
          "type": "selector",
          "title": "05 / 13 · DRINKS & TREATS",
          "key": "drink",
          "options": {
            "SHAKES": { "items": ["Chocolate"], "tag": "DESSERT", "voice": ["shake", "milkshake"] },
            "FROZEN": { "items": ["Slushie"], "tag": "ENERGY", "voice": ["frozen", "slushie", "red bull"] },
            "STANDARD": { "items": ["Pepsi"], "tag": "BASIC", "voice": ["drink", "soda", "pop", "coffee"] }
          }
        },
        { "id": "final", "type": "final", "title": "06 / 13 · ORDER TICKET" },
        { "id": "hunger", "type": "standard", "title": "07 / 13 · HUNGER CALIBRATION", "visual": { "h1": "HOW HUNGRY?", "q": "Calibrating protein requirements.", "txt": "High hunger favors Angus." }, "logic": { "txt": "Angus is 100% beef." }, "proof": { "ascii": "[ SATIETY ]" } },
        {
          "id": "timing",
          "type": "selector",
          "title": "08 / 13 · TIMING STRATEGY",
          "key": "timing",
          "options": {
            "OFF-PEAK": { "items": ["After 2:00 PM"], "tag": "SMART", "voice": ["off peak", "quiet", "later"] },
            "PEAK": { "items": ["Lunch Rush"], "tag": "RISKY", "voice": ["peak", "rush", "lunch", "dinner"] }
          }
        },
        { "id": "consistency", "type": "standard", "title": "09 / 13 · HUMAN FACTOR", "visual": { "h1": "EXECUTION RISK", "q": "Can you tolerate inconsistency?", "txt": "Depends on garnish operator." }, "logic": { "txt": "Human scooping has variance." }, "proof": { "ascii": "[ VARIANCE ]" } },
        { "id": "patty-logic", "type": "standard", "title": "10 / 13 · PATTY ARCHITECTURE", "visual": { "h1": "TEXTURE PROFILE", "q": "Mouthfeel Difference.", "txt": "Original is softer." }, "logic": { "txt": "Angus holds toppings better." }, "proof": { "ascii": "[ DENSITY ]" } },
        { "id": "method", "type": "standard", "title": "11 / 13 · THE RITUAL", "visual": { "h1": "GARNISH CONTROL", "q": "Why Harvey’s feels different", "txt": "Live assembly." }, "logic": { "txt": "Open counters force accountability." }, "proof": { "ascii": "[ ERRORS ]" } },
        { "id": "value-stack", "type": "standard", "title": "12 / 13 · VALUE STACKING", "visual": { "h1": "MINIMIZE SPEND", "q": "Don't pay menu price.", "txt": "Stack coupons." }, "logic": { "txt": "Paper Coupon > App Offer." }, "proof": { "ascii": "[ SAVINGS ]" } },
        { "id": "brand-end", "type": "brand", "title": "13 / 13 · THE NATIONAL CHAMPION" }
      ]
    };

    /* =========================================
       STATE & BUILDER
       ========================================= */
    let USER_CART = {}; // START EMPTY FOR ACCURACY

    const container = document.getElementById('master-container');
    let slideElements = [];
    let currentIdx = 0;
    let dragRatio = 0;
    const MAX_DRAG = 300; 
    const TRIGGER_THRESHOLD = 0.9;

    function init() {
        console.log("BOOTING SWIPE-OS v5.2...");
        
        CONFIG.slides.forEach((cfg, idx) => {
            const section = document.createElement('section');
            section.className = `main-slide ${idx === 0 ? 'active' : 'next'}`;
            section.id = cfg.id;
            section.dataset.mode = cfg.type === 'selector' ? 'options' : 'standard';

            let content = '';

            if (cfg.type === 'selector') {
                let optionsHTML = '';
                const keys = Object.keys(cfg.options);
                
                keys.forEach((k, kIdx) => {
                    const opt = cfg.options[k];
                    const itemsList = opt.items.map(i => `<li>${i}</li>`).join('');
                    const prevText = kIdx > 0 ? `&larr; ${keys[kIdx-1]}` : '';
                    const nextText = kIdx < keys.length - 1 ? `${keys[kIdx+1]} &rarr;` : '';

                    optionsHTML += `
                        <div class="sub-slide ${kIdx===0 ? 'opt-active' : 'opt-hidden'}" data-opt-idx="${kIdx}" data-val="${k}">
                            <div class="role-label">${opt.tag}</div>
                            <h1>${k}</h1>
                            <div class="primary-question">${opt.note || 'Select Option'}</div>
                            <div class="content-text">
                                <ul class="item-list">${itemsList}</ul>
                            </div>
                            <div class="nav-hint">
                                <span style="flex:1; text-align:left;">${prevText}</span>
                                <span style="flex:2; text-align:center; color:#fff; font-weight:bold;">&darr; PULL TO SELECT &darr;</span>
                                <span style="flex:1; text-align:right;">${nextText}</span>
                            </div>
                        </div>
                    `;
                });

                content = `
                    <div class="slide-header"><span class="header-title">${cfg.title}</span></div>
                    <div class="carousel-viewport" data-key="${cfg.key}" data-total="${keys.length}">
                        ${optionsHTML}
                    </div>`;
            }

            else if (cfg.type === 'standard') {
                content = `
                    <div class="slide-header"><span class="header-title">${cfg.title}</span></div>
                    <div class="carousel-viewport">
                        <div class="sub-slide layer-1">
                            <h1>${cfg.visual.h1}</h1>
                            <div class="primary-question">${cfg.visual.q}</div>
                            <div class="content-text">${cfg.visual.txt}</div>
                            <small style="color:#666; margin-top:30px; font-size:0.7rem;">&darr; Pull Down &darr;</small>
                        </div>
                        <div class="sub-slide layer-2" style="opacity:0;">
                            <div class="role-label">LOGIC</div>
                            <div class="content-text">${cfg.logic.txt}</div>
                        </div>
                        <div class="sub-slide layer-3" style="opacity:0;">
                            <div class="role-label">PROOF</div>
                            <div class="ascii-box">${cfg.proof.ascii}</div>
                        </div>
                    </div>`;
            }

            else if (cfg.type === 'final') {
                content = `
                    <div class="slide-header"><span class="header-title">${cfg.title}</span></div>
                    <div class="carousel-viewport">
                        <div class="sub-slide layer-1">
                            <div class="verdict-container">
                                <div class="choice-header">YOUR CHOICES</div>
                                <div class="input-group" id="final-inputs"></div>
                                <div class="choice-header">PRIMARY SELECTION</div>
                                <div class="hero-section">
                                    <div class="hero-burger" id="hero-burger-name">NO BURGER</div>
                                    <div class="hero-sub" style="display:none;">FLAME-GRILLED</div>
                                </div>
                                <div class="final-actions">
                                    <button class="btn btn-wa" onclick="sendWhatsappTicket()">SAVE TICKET</button>
                                    <button class="btn btn-support" onclick="sendSupport()">SUPPORT</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            else if (cfg.type === 'brand') {
                content = `
                    <div class="slide-header"><span class="header-title">${cfg.title}</span></div>
                    <div class="carousel-viewport">
                        <div class="sub-slide layer-1">
                            <div class="verdict-container" style="justify-content:center;">
                                <div class="brand-logo-placeholder">H</div>
                                <div class="choice-header" style="color:var(--brand-orange); margin-bottom:10px;">100% CANADIAN</div>
                                <h1>THE BURGER BOSS</h1>
                                <div class="primary-question" style="text-align:center;">"It's a Beautiful Thing"</div>
                                <div class="content-text" style="text-align:center;">
                                    Founded in 1959. Harvey's garnishes every burger to order. 
                                </div>
                                <div class="final-actions" style="margin-top:40px;">
                                    <button class="btn btn-share" onclick="copyLink()">SHARE THIS APP</button>
                                    <button class="btn" onclick="location.reload()">START OVER</button>
                                    <button class="btn btn-insta" onclick="followInsta()">FOLLOW ON INSTA</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            section.innerHTML = content;
            container.appendChild(section);
        });

        slideElements = Array.from(document.querySelectorAll('.main-slide'));
        attachEvents();
    }

    /* =========================================
       LOGIC ENGINE
       ========================================= */
    function updateResult() {
        const container = document.getElementById('final-inputs');
        const burgerName = document.getElementById('hero-burger-name');
        const heroSub = document.querySelector('.hero-sub');
        
        if (USER_CART.burger) {
            burgerName.innerText = USER_CART.burger;
            heroSub.innerText = "FLAME-GRILLED";
            heroSub.style.display = 'block';
        } else {
            burgerName.innerText = "NO BURGER";
            heroSub.style.display = 'none';
        }

        let html = '';
        const keys = ['chicken', 'side', 'drink', 'timing', 'value']; 
        
        let hasItems = false;
        keys.forEach(k => {
            if(USER_CART[k]) {
                hasItems = true;
                html += `
                <div class="input-row">
                    <span class="input-key">${k.toUpperCase()}</span>
                    <span class="input-val">${USER_CART[k]}</span>
                </div>`;
            }
        });
        
        if (!hasItems && !USER_CART.burger) {
            html = '<div style="text-align:center; color:#666; padding:20px;">No items selected yet.<br>Swipe or speak to build order.</div>';
        }
        
        container.innerHTML = html;
    }

    // Save Ticket
    function sendWhatsappTicket() {
        let msg = "MY HARVEY'S ORDER:\n";
        Object.keys(USER_CART).forEach(k => msg += `- ${k.toUpperCase()}: ${USER_CART[k]}\n`);
        window.open(`https://wa.me/916351537770?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // Support Action
    function sendSupport() {
        const msg = "I needed assistance with my order flow. Thanks!. How can I Support";
        window.open(`https://wa.me/916351537770?text=${encodeURIComponent(msg)}`, '_blank');
    }

    // Share Link Action
    function copyLink() {
        const url = "https://dharamdaxini.github.io/via.decide.food/";
        navigator.clipboard.writeText(url).then(() => {
            showToast('LINK COPIED TO CLIPBOARD');
        });
    }

    // Follow Insta Action
    function followInsta() {
        window.open('https://www.instagram.com/harveys?igsh=MWY0M3VyemQ2NHFjZw==', '_blank');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('visible');
        setTimeout(() => t.classList.remove('visible'), 2000);
    }

    function goToSlide(idx) {
        if (idx < 0 || idx >= slideElements.length) return;

        const curr = slideElements[currentIdx];
        curr.classList.remove('active', 'deck-active');
        
        if (idx > currentIdx) {
            curr.classList.add('prev');
            curr.classList.remove('next');
        } else {
            curr.classList.add('next');
            curr.classList.remove('prev');
        }
        
        const deck = curr.querySelector('.carousel-viewport')._deck;
        if(deck && deck.slides) updateLayers(deck.slides, 0);

        currentIdx = idx;
        const next = slideElements[currentIdx];
        
        next.classList.remove('prev', 'next');
        next.classList.add('active');

        if(next.id === 'final') updateResult();

        dragRatio = 0;
        document.getElementById('depth-fill').style.height = '0%';
    }

    function updateLayers(slides, ratio) {
        if(!slides[0]) return; 
        if(slides[0].closest('.main-slide').dataset.mode === 'options') return;

        const vis = slides[0];
        const log = slides[1];
        const prf = slides[2];

        if (ratio > 0.1) {
            vis.style.transform = `translateY(${ratio * -80}px) scale(${1 - ratio*0.1})`;
            vis.style.opacity = Math.max(0, 1 - ratio*3);
        } else {
            vis.style.transform = ''; vis.style.opacity = 1;
        }

        if (log) {
            if (ratio > 0.25 && ratio < 0.65) {
                log.style.opacity = Math.min(1, (ratio - 0.25) * 4);
                log.style.transform = `translateY(${100 - (ratio-0.25)*300}px)`;
            } else if (ratio > 0.65) {
                log.style.opacity = Math.max(0, 1 - (ratio - 0.65) * 4);
                log.style.transform = `translateY(-50px)`;
            } else {
                log.style.opacity = 0; log.style.transform = `translateY(100px)`;
            }
        }

        if (prf) {
            if (ratio > 0.55) {
                prf.style.opacity = Math.min(1, (ratio - 0.55) * 4);
                prf.style.transform = `translateY(${100 - (ratio-0.55)*300}px)`;
            } else {
                prf.style.opacity = 0; prf.style.transform = `translateY(100px)`;
            }
        }

        const bar = document.getElementById('depth-fill');
        bar.style.height = (ratio * 100) + '%';
        if(ratio < 0.3) bar.style.background = '#333';
        else if(ratio < 0.6) bar.style.background = '#ff671f';
        else if(ratio < 0.9) bar.style.background = '#00e676';
        else bar.style.background = '#fff';
    }

    /* =========================================
       LISTEN MODE & TOUCH ENGINE
       ========================================= */
    let isListening = false;
    let recognition;

    function toggleListenMode() {
        if (!('webkitSpeechRecognition' in window)) {
            alert("Voice not supported. Try Chrome/Safari.");
            return;
        }

        const micBtn = document.getElementById('mic-toggle');
        const feedback = document.getElementById('voice-feedback');

        if (isListening) {
            recognition.stop();
            isListening = false;
            micBtn.classList.remove('listening');
            feedback.classList.remove('visible');
        } else {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = false;
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('listening');
                feedback.classList.add('visible');
                feedback.innerText = "LISTENING...";
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.toLowerCase().trim();
                feedback.innerText = `HEARD: "${transcript}"`;
                processVoiceCommand(transcript);
            };

            recognition.start();
        }
    }

    function processVoiceCommand(cmd) {
        // GLOBAL NAVIGATION
        if (cmd.includes("next")) { goToSlide(currentIdx + 1); return; }
        if (cmd.includes("back") || cmd.includes("previous")) { goToSlide(currentIdx - 1); return; }
        if (cmd.includes("start over") || cmd.includes("reset")) { location.reload(); return; }

        // ACTIONS
        if (cmd.includes("save") || cmd.includes("ticket")) { sendWhatsappTicket(); return; }
        if (cmd.includes("support") || cmd.includes("help")) { sendSupport(); return; }
        if (cmd.includes("share")) { copyLink(); return; }
        if (cmd.includes("instagram") || cmd.includes("insta") || cmd.includes("follow")) { followInsta(); return; }

        // NAVIGATION JUMPS
        if (cmd.includes("go to burger") || cmd.includes("show me burgers")) { goToSlide(0); return; }
        if (cmd.includes("go to chicken") || cmd.includes("show me chicken")) { goToSlide(1); return; }
        if (cmd.includes("go to sides") || cmd.includes("show me sides")) { goToSlide(2); return; }
        if (cmd.includes("go to value") || cmd.includes("show me value")) { goToSlide(3); return; }
        if (cmd.includes("go to drinks") || cmd.includes("show me drinks")) { goToSlide(4); return; }
        if (cmd.includes("go to ticket") || cmd.includes("show order")) { goToSlide(5); return; }

        // SELECTION LOGIC (Scan Config)
        CONFIG.slides.forEach(slide => {
            if (slide.type === 'selector') {
                Object.keys(slide.options).forEach(optKey => {
                    const opt = slide.options[optKey];
                    if (opt.voice) {
                        opt.voice.forEach(keyword => {
                            if (cmd.includes(keyword)) {
                                selectOption(slide.key, optKey);
                            }
                        });
                    }
                });
            }
        });
    }

    function selectOption(category, value) {
        USER_CART[category] = value;
        showToast(`SELECTED: ${value}`);
        // Refresh display if on ticket
        if(slideElements[currentIdx].id === 'final') updateResult();
    }

    function attachEvents() {
        let startX = 0, startY = 0;

        document.querySelectorAll('.carousel-viewport').forEach(view => {
            const slides = Array.from(view.querySelectorAll('.sub-slide'));
            view._deck = { slides, currOpt: 0 };
            
            let isDragging = false;
            let axis = null;

            view.addEventListener('touchstart', e => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                axis = null;
            }, {passive: true});

            view.addEventListener('touchmove', e => {
                if(!isDragging) return;
                const dx = e.touches[0].clientX - startX;
                const dy = e.touches[0].clientY - startY;

                if(!axis) axis = Math.abs(dx) > Math.abs(dy) ? 'x' : 'y';

                const parentSlide = view.closest('.main-slide');
                const isOptions = parentSlide.dataset.mode === 'options';

                if(axis === 'y' && dy < 0) return; 

                if(isOptions) {
                    if(axis === 'x') slides.forEach(s => s.style.transform = `translateX(${dx}px)`);
                    if(axis === 'y' && dy > 0) slides.forEach(s => s.style.transform = `translateY(${dy * 0.3}px)`);
                    return;
                }

                if(axis === 'y' && dy > 0) {
                    e.preventDefault();
                    dragRatio = Math.min(dy / MAX_DRAG, 1);
                    updateLayers(view._deck.slides, dragRatio);
                    parentSlide.classList.add('deck-active');
                }
            }, {passive: false});

            view.addEventListener('touchend', e => {
                if(!isDragging) return;
                isDragging = false;
                
                const dx = e.changedTouches[0].clientX - startX;
                const dy = e.changedTouches[0].clientY - startY;
                const parentSlide = view.closest('.main-slide');
                const isOptions = parentSlide.dataset.mode === 'options';

                if (axis === 'y' && dy < -60) {
                    if (currentIdx > 0) {
                        goToSlide(currentIdx - 1);
                        return;
                    }
                }

                if(isOptions) {
                    const key = view.dataset.key;
                    const total = parseInt(view.dataset.total);
                    let curr = view._deck.currOpt;

                    if(axis === 'x' && Math.abs(dx) > 50) {
                        if(dx < 0 && curr < total - 1) curr++; 
                        else if(dx > 0 && curr > 0) curr--;   
                        
                        view._deck.currOpt = curr;
                        
                        slides.forEach((s, i) => {
                            if(i === curr) {
                                s.classList.remove('opt-hidden');
                                s.classList.add('opt-active');
                                USER_CART[key] = s.dataset.val;
                            } else {
                                s.classList.remove('opt-active');
                                s.classList.add('opt-hidden');
                            }
                        });
                    }
                    
                    slides.forEach(s => s.style.transform = '');

                    if(axis === 'y' && dy > 60) {
                        if(!USER_CART[key]) USER_CART[key] = slides[view._deck.currOpt].dataset.val;
                        goToSlide(currentIdx + 1);
                    }
                    return;
                }

                if(axis === 'y' && dy > 0) {
                    if(dragRatio > TRIGGER_THRESHOLD) {
                        goToSlide(currentIdx + 1);
                    } else {
                        parentSlide.classList.remove('deck-active');
                        updateLayers(view._deck.slides, 0);
                        document.getElementById('depth-fill').style.height = '0%';
                    }
                    dragRatio = 0;
                }
            });
        });
    }

    init(); // BOOT

</script>
</body>
</html>
