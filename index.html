<!DOCTYPE html>
<html lang="en">
<head>
<link rel="manifest" href="manifest.json">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Alchemist | Kinetic v147.6 PATCHED</title>

<link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;0,700;1,400&family=Inter:wght@400;500;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
/* KINETIC VISUAL CORE */
:root{ --bg:#000000; --card:#0a0a0a; --border:#222; --gold:#ffd600; --green:#2ecc71; --red:#ff4444; --text-white:#ffffff; --text-grey:#888888; --font-serif:'Crimson Text',serif; --font-sans:'Inter',sans-serif; --font-code:'JetBrains Mono',monospace; }
*{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
body{margin:0; height:100vh; background:var(--bg); color:var(--text-white); font-family:var(--font-sans); overflow:hidden; display:flex; flex-direction:column;}

/* HEADER & LOGS */
#header{width:90%; margin:25px auto 0; z-index:100; flex-shrink:0;}
.header-meta{display:flex; justify-content:space-between; font-family:var(--font-code); font-size:0.75rem; color:#666; letter-spacing:1.5px; text-transform:uppercase; margin-bottom:15px;}
.progress-track{width:100%; height:3px; background:#222; border-radius:2px;}
#progress-bar{height:100%; background:var(--gold); width:0%; transition:width 0.4s ease; border-radius:2px;}

#kinetic-logger{width:90%; margin:15px auto 5px; font-family:var(--font-code); font-size:0.8rem; color:#444; line-height:1.4; text-transform:uppercase; min-height:60px; display:flex; flex-direction:column; justify-content:flex-end;}
.log-line{opacity:0.5; transition:opacity 0.2s;} 
.log-line.active{color:var(--green); opacity:1; font-weight:700;} 
.log-line.primary{color:var(--gold); opacity:1; font-weight:700;}
.log-line.danger{color:var(--red); opacity:1; font-weight:700;}

/* SENSOR STATUS PILL */
#gyro-status { 
    position: absolute; top: 20px; left: 50%; transform: translateX(-50%); 
    font-family: var(--font-code); font-size: 0.6rem; color: #444; 
    border: 1px solid #333; padding: 4px 8px; border-radius: 4px; 
    opacity: 0; transition: opacity 0.5s; pointer-events: none;
}
#gyro-status.active { opacity: 1; color: var(--gold); border-color: var(--gold); }

/* RE-CENTERING HINT */
#center-hint { display: none; } 

/* PHYSICS STACK */
#stack{position:relative; width:90%; max-width:420px; height:calc(100vh - 220px - env(safe-area-inset-bottom)); margin:10px auto 20px; perspective:1500px; display:flex; align-items:center; justify-content:center;}
.card{
    position:absolute; width:100%; height:100%; background:var(--card); 
    border-radius:14px; border:1px solid var(--border); padding:35px; 
    display:flex; flex-direction:column; justify-content:center; align-items:center; 
    box-shadow:0 20px 60px rgba(0,0,0,0.95); 
    will-change: transform; 
    transform-style:preserve-3d; overflow:hidden;
}

/* LOCKED STATE */
.card.locked { opacity: 0.2; transform: scale(0.96); transition: opacity 0.3s, transform 0.3s; filter: grayscale(100%); }

.card-q{
    font-family:var(--font-serif); font-size:clamp(1.4rem, 5vw, 1.9rem); line-height:1.4; font-weight:600; 
    text-align:center; color:var(--text-white); width:100%; max-height:100%; overflow-y:auto; 
    word-wrap:break-word; padding:0 5px; display:flex; flex-direction:column; justify-content:center;
    transition: transform 0.1s ease-out; /* Parallax */
}
.card-q::-webkit-scrollbar{width:0px;} 
.card-q sub{font-size:0.7em; vertical-align:-0.3em;} .card-q sup{font-size:0.7em; vertical-align:0.5em;}

/* SWIPE LABELS */
.swipe-label{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center; 
    background:rgba(0,0,0,0.85); font-family:var(--font-sans); font-weight:900; 
    font-size:1.6rem; text-transform:uppercase; letter-spacing:1px; text-align:center; 
    padding:40px; opacity:0; pointer-events:none; transition:opacity 0.1s ease, transform 0.1s ease; 
    border-radius:14px; color:var(--text-white); border:1px solid #444;
    transform: scale(0.9);
}
</style>
</head>
<body>

<div id="gyro-status">HYBRID SENSORS READY</div>

<div id="header">
  <div class="header-meta">
    <span id="id-ui">VIA.STACK</span> 
    <span id="xp-ui">0 XP</span>
  </div>
  <div class="progress-track"><div id="progress-bar"></div></div>
</div>

<div id="kinetic-logger">
  <div class="log-line" id="log-1">> SYSTEM BOOT</div>
  <div class="log-line" id="log-2">> APPLYING PATCHES...</div>
  <div class="log-line active" id="log-3">> ...</div>
</div>

<div id="stack">
  <div class="card">
    <div class="card-q" style="font-family:var(--font-code); font-size:0.9rem; color:#666; font-style:normal;">LOADING PATCHED CORE...</div>
  </div>
</div>

<script>
/* =========================================
   VIA.STACK | KINETIC v147.6 PATCHED
   ========================================= */

// --- CONFIGURATION ---
const BEACON_URL = "https://script.google.com/macros/s/AKfycbzSxk_so64KtqwpvzvJSyTv2JydsD91BJEyl5jIKlzDopXRW-DOSoXbutfIARSDEiFE/exec"; 
const WA_NUMBER = "916351537770"; 
const MASTER_KEY = "ALCHEMIST_MASTER_V1"; 

// --- SPHERICAL PHYSICS CONFIG ---
const BALL_WEIGHT = 0.08;
const SPHERE_RADIUS_PX = 1000; 
const HOVER_ANGLE_DEG = 10; 
const CLICK_ANGLE_DEG = 15; 
const UNLOCK_ANGLE_DEG = 2.0;

let SENSORS_ENABLED = false;

// --- STATIC DATA ---
const INJECTED_DATA = [
  { "id": "001", "set": "SET_A", "dom": "Physical Chemistry", "topic": "Solutions", "q": "According to Henrys Law what is the mathematical relationship between the partial pressure p of a gas and its mole fraction chi in the solution", "u": "p equals K H times chi", "l": "p equals K H divided by chi", "r": "p equals chi divided by K H", "correct": "UP", "logic": "Henrys Law states that at a constant temperature, the solubility of a gas in a liquid is directly proportional to the partial pressure of that gas. The modern equation is p equals K H times chi, where K H is Henrys Law constant.", "hint": "Pressure is the product of Henrys constant and mole fraction.", "ref": "NCERT Chemistry Class 12", "link": "https://ncert.nic.in/textbook.php", "trap": "Inverting the relationship or dividing by the constant.", "s1": "Identify the variables pressure and mole fraction.", "s2": "Recall the linear proportionality constant K H.", "status": "VERIFIED" },
  { "id": "002", "set": "SET_AA", "dom": "Physical Chemistry", "topic": "Solutions", "q": "Why does the solubility of gases in liquids generally decrease with an increase in temperature", "u": "Dissolution is an exothermic process", "l": "Dissolution is an endothermic process", "r": "Gases become less dense at high temperatures", "correct": "UP", "logic": "Dissolving a gas in a liquid is essentially a condensation process, which is exothermic (Delta H sol is negative). According to Le Chateliers Principle, increasing temperature shifts the equilibrium backward favor of the gas phase, reducing solubility.", "hint": "Exothermic dissolution implies heat hinders solubility.", "ref": "NCERT Chemistry Class 12", "link": "https://chem.libretexts.org/Bookshelves/Physical_and_Theoretical_Chemistry_Textbook_Maps/Physical_Chemistry_(LibreTexts", "trap": "Confusing gas solubility with solid solubility (which is often endothermic).", "s1": "Classify gas dissolution as exothermic or endothermic.", "s2": "Apply Le Chateliers Principle to the temperature change.", "status": "VERIFIED" },
  { "id": "023", "set": "SET_A", "dom": "Physical Chemistry", "topic": "Electrochemistry", "q": "What happens to the lead sulfate PbSO4 at the electrodes during the recharging of a lead acid battery", "u": "It converts back to Pb and PbO2", "l": "It dissolves into the electrolyte", "r": "It oxidizes to PbO", "correct": "UP", "logic": "During recharge, the cell operates as an electrolytic cell. The solid Lead Sulfate (PbSO4) on the electrodes is converted back into Lead (Pb) at the anode and Lead Dioxide (PbO2) at the cathode, regenerating the active materials.", "hint": "PbSO4 reverts to original electrode materials.", "ref": "NCERT Chemistry Class 12", "link": "https://ncert.nic.in/textbook.php", "trap": "Thinking it remains as sulfate.", "s1": "Identify the mode of operation (Electrolytic).", "s2": "Trace the reverse reaction of the discharge products.", "status": "VERIFIED" }
];

// --- STATE (PATCH 1: BEACON FIX) ---
let RAW_DATA = [], POOL = [], WRONG = [], SESSION_ALL = [];
let SET_CURSOR = 0, ACTIVE_SET = null, XP = 0, VOLUME_LIMIT = null;
let ATTEMPTED = new Set(); 
let SES_BEACON_SENT = false; // <-- PATCH 1

// --- TELEMETRY ---
let Q_START_TIME = 0;
let SESSION_LOG = []; 
let PIVOT_COUNT = 0;

// --- BACKEND ---
let USER_MOBILE = localStorage.getItem("USER_MOBILE") || null;
let CURRENT_SES_ID = null;
let CREDITS = parseInt(localStorage.getItem("USER_CREDITS") || "10");
let VAULT = [];
try { VAULT = JSON.parse(localStorage.getItem("USER_VAULT") || "[]"); } catch(e) { VAULT = []; }

/* ================= UTILS ================= */
function log(msg, type="normal") {
    const l1 = document.getElementById("log-1"), l2 = document.getElementById("log-2"), l3 = document.getElementById("log-3");
    l1.innerText = l2.innerText; l1.className = l2.className;
    l2.innerText = l3.innerText; l2.className = "log-line"; 
    l3.innerText = `> ${msg}`;
    l3.className = type === "active" ? "log-line active" : type === "primary" ? "log-line primary" : type === "danger" ? "log-line danger" : "log-line";
}

/* ================= HYBRID PHYSICS ENGINE ================= */
const chemText = t => String(t||"").replace(/_(\d+)/g,"<sub>$1</sub>").replace(/\^([0-9+\-]+)/g,"<sup>$1</sup>").replace(/<->|â†”/g,"â‡Œ");

class PhysicsController {
 constructor(el, cbs, sensorsActive = true) {
  this.el = el; this.cbs = cbs; 
  this.qEl = el.querySelector(".card-q"); 
  this.active = false; 
  this.locked = false; 
  this.awaitingRecenter = true; 
  
  this.current = {x:0, y:0}; 
  this.target = {x:0, y:0};  
  
  this.labels = {UP:el.querySelector(".sl-up"), LEFT:el.querySelector(".sl-left"), RIGHT:el.querySelector(".sl-right"), DOWN:el.querySelector(".sl-down")};
  
  this.el.classList.add('locked');
  
  const s = e => this.startDrag(e.touches?e.touches[0]:e); 
  const m = e => this.move(e.touches?e.touches[0]:e); 
  const e2 = () => this.end();
  el.addEventListener("mousedown",s); window.addEventListener("mousemove",m); window.addEventListener("mouseup",e2);
  el.addEventListener("touchstart",s,{passive:false}); el.addEventListener("touchmove",ev=>{if(this.active)ev.preventDefault();m(ev)},{passive:false}); el.addEventListener("touchend",e2);

  if(SENSORS_ENABLED && sensorsActive) {
      this.handleMouseTether = this.handleMouseTether.bind(this);
      this.handleMouseCommit = this.handleMouseCommit.bind(this);
      window.addEventListener("mousemove", this.handleMouseTether);
      window.addEventListener("mousedown", this.handleMouseCommit);
      
      this.handleOrientation = this.handleOrientation.bind(this);
      if(window.DeviceOrientationEvent) window.addEventListener("deviceorientation", this.handleOrientation);
      
      this.loop = this.loop.bind(this);
      this.raf = requestAnimationFrame(this.loop);
  } else {
      this.unlockCard();
  }
 }

 unlockCard() {
     if(!this.awaitingRecenter) return;
     this.awaitingRecenter = false;
     this.el.classList.remove('locked');
 }

 cleanup() {
     cancelAnimationFrame(this.raf);
     window.removeEventListener("mousemove", this.handleMouseTether);
     window.removeEventListener("mousedown", this.handleMouseCommit);
     window.removeEventListener("deviceorientation", this.handleOrientation);
 }

 // --- PHYSICS LOOP ---
 loop() {
     if(this.active || this.locked) return; 

     this.current.x += (this.target.x - this.current.x) * BALL_WEIGHT;
     this.current.y += (this.target.y - this.current.y) * BALL_WEIGHT;

     if(this.awaitingRecenter && SENSORS_ENABLED) {
         const tiltMag = Math.hypot(this.target.x, this.target.y);
         const unlockThresh = SPHERE_RADIUS_PX * Math.tan(UNLOCK_ANGLE_DEG * Math.PI / 180);
         if(tiltMag < unlockThresh) this.unlockCard();
     }

     if(!this.awaitingRecenter) {
         this.updateVisuals(this.current.x, this.current.y);
         
         if(SENSORS_ENABLED) {
             const clickThresh = SPHERE_RADIUS_PX * Math.tan(CLICK_ANGLE_DEG * Math.PI / 180);
             if(Math.abs(this.current.x) > clickThresh) {
                 this.commitWithAnimation(Math.sign(this.current.x)*100, 0);
             } 
             else if(Math.abs(this.current.y) > clickThresh) {
                 this.commitWithAnimation(0, Math.sign(this.current.y)*100);
             }
         }
     }
     
     this.raf = requestAnimationFrame(this.loop);
 }

 handleMouseTether(e) {
     if(this.active || this.locked) return; 
     const cx = window.innerWidth / 2;
     const cy = window.innerHeight / 2;
     this.target.x = (e.clientX - cx) * 0.8;
     this.target.y = (e.clientY - cy) * 0.8;
 }

 handleMouseCommit(e) {
     if(this.active || this.locked || this.awaitingRecenter) return;
     if(Math.abs(this.target.x) > 80 || Math.abs(this.target.y) > 80) {
         this.commitWithAnimation(this.target.x, this.target.y);
     }
 }

 handleOrientation(event) {
     if(this.active || this.locked) return;

     let g = event.gamma; 
     let b = event.beta - 45; 

     let radX = (g * Math.PI) / 180;
     let radY = (b * Math.PI) / 180;

     const MAX_RAD = 20 * Math.PI / 180;
     radX = Math.max(-MAX_RAD, Math.min(MAX_RAD, radX));
     radY = Math.max(-MAX_RAD, Math.min(MAX_RAD, radY));

     if(Math.abs(g) > 0.5) this.target.x = SPHERE_RADIUS_PX * Math.tan(radX);
     else this.target.x = 0;

     if(Math.abs(b) > 0.5) this.target.y = SPHERE_RADIUS_PX * Math.tan(radY);
     else this.target.y = 0;
 }

 commitWithAnimation(dx, dy) {
     this.locked = true;
     this.cleanup(); 
     
     const flyX = dx * 6;
     const flyY = dy * 6;
     
     this.el.style.transition = "0.4s cubic-bezier(0.2, 0.8, 0.2, 1)";
     this.el.style.transform = `translate(${flyX}px, ${flyY}px) rotate(${flyX/15}deg)`;
     this.el.style.opacity = "0";

     setTimeout(() => {
         this.cbs.onCommit(this.dir(dx, dy));
     }, 300);
 }

 startDrag(p){ 
     this.active=true; 
     this.unlockCard(); 
     this.start={x:p.clientX, y:p.clientY}; 
     this.el.style.transition="none"; 
 }
 move(p){ 
     if(!this.active) return;
     this.updateVisuals(p.clientX - this.start.x, p.clientY - this.start.y);
 }
 end(){
     if(!this.active) return; this.active=false;
     const m = new WebKitCSSMatrix(getComputedStyle(this.el).transform);
     if(Math.hypot(m.m41, m.m42) > 100) this.cbs.onCommit(this.dir(m.m41, m.m42));
     else { this.el.style.transition="0.3s cubic-bezier(0.2,0.8,0.2,1)"; this.el.style.transform="translate(0,0)"; }
 }

 updateVisuals(dx, dy) {
     this.el.style.transform = `translate(${dx}px, ${dy}px) rotate(${dx/25}deg)`;
     if(this.qEl) this.qEl.style.transform = `translate(${-dx/8}px, ${-dy/8}px)`;

     const d = Math.hypot(dx, dy);
     
     Object.values(this.labels).forEach(l => l && (l.style.opacity = 0));
     
     if(d > 30) {
         const dir = this.dir(dx, dy);
         if(this.labels[dir]) {
             const opacity = Math.min((d-30)/140, 1);
             this.labels[dir].style.opacity = opacity;
             this.labels[dir].style.transform = `scale(${0.9 + (opacity * 0.1)})`;
         }
     }
 }

 dir(dx, dy){
     const a = (Math.atan2(-dy, dx) * 180 / Math.PI + 360) % 360;
     if(a>45 && a<135) return "UP"; if(a>135 && a<225) return "LEFT"; if(a>225 && a<315) return "DOWN"; return "RIGHT";
 }
}

const UI = {stack:document.getElementById("stack"), id:document.getElementById("id-ui"), xp:document.getElementById("xp-ui"), bar:document.getElementById("progress-bar"), gyro:document.getElementById("gyro-status")};

function card(text, labels, cb, allowSensors = true) {
 UI.stack.innerHTML=""; const el=document.createElement("div"); el.className="card";
 el.innerHTML=`<div class="card-q">${chemText(text).replace(/\n/g,"<br>")}</div>
  <div class="swipe-label sl-up">${chemText(labels.up)||""}</div><div class="swipe-label sl-left">${chemText(labels.left)||""}</div><div class="swipe-label sl-right">${chemText(labels.right)||""}</div><div class="swipe-label sl-down">${chemText(labels.down)||""}</div>`;
 UI.stack.appendChild(el); 
 Q_START_TIME = Date.now();
 new PhysicsController(el, {onCommit:cb}, allowSensors);
}

// --- PATCH 3: LLM INTERFACE ---
async function LLM_DECIDE(payload) {
    // ðŸ” STATIC MODE (Placeholder for Gemini)
    return null;
}

function pingAdmin() {
    log("PINGING ADMIN...", "primary");
    fetch(BEACON_URL, { method: "GET" }) 
        .then(res => res.json())
        .then(data => {
            if(data.status === "ONLINE") {
                log("ADMIN v146.2 CONNECTED", "active");
            } else {
                log("ADMIN STATUS: UNKNOWN", "danger");
            }
        })
        .catch(e => {
            log("ADMIN DISCONNECTED", "danger");
        });
}

function begin(){
 if(USER_MOBILE) log(`LOGIN: ${USER_MOBILE} | CREDITS: ${CREDITS}`, "primary");
 else log("LOGIN: GUEST | CREDITS: " + CREDITS, "normal");
 
 const tiltLabel = SENSORS_ENABLED ? "SENSORS ACTIVE" : "ENABLE TILT";
 
 card(`DATA LOADED\n${RAW_DATA.length} UNITS`,{up:"START QUIZ", down:tiltLabel, left:"VAULT", right:"RELOAD"}, dir=>{
  if(dir==="UP") setPick(); 
  if(dir==="DOWN") requestSensorAccess(); 
  if(dir==="LEFT") checkLoginForVault();
  if(dir==="RIGHT") location.reload();
 });
}

// --- PATCH 2: SENSOR RECURSION FIX ---
function requestSensorAccess() {
    if (SENSORS_ENABLED) return;
    SENSORS_ENABLED = true;
    UI.gyro.classList.add('active');
    
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        DeviceOrientationEvent.requestPermission()
            .then(state => {
                if (state === 'granted') log("GYRO ENABLED", "active");
                else log("GYRO DENIED (MOUSE ONLY)", "danger");
            })
            .catch(() => log("MOUSE MODE ONLY", "normal"));
    } else {
        log("HYBRID SENSORS ON", "active");
    }
    // REMOVED begin() CALL TO PREVENT DUPLICATION
}

function checkLoginForVault(){
    if(USER_MOBILE && USER_MOBILE.length > 5){ openVault(0); return; }
    const mob = prompt("SECURE VAULT ACCESS\n\nEnter your Registered Mobile Number to unlock:");
    if(mob && mob.length >= 10){
        localStorage.setItem("USER_MOBILE", mob); USER_MOBILE = mob;
        log(`LOGIN SUCCESS: ${mob}`, "active"); openVault(0);
    } else { log("ACCESS DENIED", "danger"); begin(); }
}

function openVault(index){
    if(VAULT.length === 0){ 
        card("LOCAL ARCHIVE EMPTY\n\nRecover from Cloud?", {down:"WHATSAPP", up:"MENU"}, dir => {
            if(dir==="DOWN") {
                const lastSes = localStorage.getItem("LAST_SES_ID") || "UNKNOWN";
                const text = `VAULT_RECOVERY || MOB: ${USER_MOBILE || "UNKNOWN"} || LAST_ID: ${lastSes}`;
                window.open(`https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`, '_blank');
            }
            else begin();
        });
        return; 
    }
    if(index < 0) { begin(); return; } 
    if(index >= VAULT.length) index = VAULT.length - 1;

    const item = VAULT[index];
    
    log(`ARCHIVE: ${item.id}`, "primary");
    card(`VAULT // ${item.id}\n\nSCORE: ${item.score}/${item.total}\n${item.date}`,
        { up: "OPEN PDF", left: "PREV", right: "NEXT" }, 
        dir => {
            if(dir === "LEFT") openVault(index - 1);
            if(dir === "RIGHT") openVault(index + 1);
            if(dir === "UP") {
                log("OPENING ARCHIVE...", "active");
                renderSessionPDF(item.data, item.id);
            }
        }, false 
    );
}

function setPick(){
 const sets=[...new Set(RAW_DATA.map(d=>d.set))];
 if(sets.length===0){card("NO DATA FOUND",{down:"RETRY"},()=>location.reload());return;}
 card(sets[SET_CURSOR],{left:"",right:"",up:"SELECT",down:"BACK"},dir=>{
  if(dir==="LEFT"){SET_CURSOR=(SET_CURSOR-1+sets.length)%sets.length;setPick();}
  if(dir==="RIGHT"){SET_CURSOR=(SET_CURSOR+1)%sets.length;setPick();}
  if(dir==="UP"){ACTIVE_SET=sets[SET_CURSOR];volumePick();}
  if(dir==="DOWN")begin();
 });
}

function volumePick(){
 card(`QUESTION VOLUME`,{up:"10 Q",left:"25 Q",right:"50 Q",down:"ALL"},dir=>{
    if(dir==="UP")VOLUME_LIMIT=10; if(dir==="LEFT")VOLUME_LIMIT=25; if(dir==="RIGHT")VOLUME_LIMIT=50; if(dir==="DOWN")VOLUME_LIMIT=null;
    startQuiz();
 });
}

function startQuiz(){
 log("INITIATING QUIZ...", "active");
 let base = RAW_DATA.filter(d=>d.set===ACTIVE_SET);
 base = shuffle(base); 
 if(VOLUME_LIMIT && VOLUME_LIMIT < base.length) base = base.slice(0, VOLUME_LIMIT);
 POOL=base; WRONG=[]; SESSION_ALL=[]; XP=0; ATTEMPTED=new Set();
 CURRENT_SES_ID = null; SES_BEACON_SENT = false; 
 SESSION_LOG = []; PIVOT_COUNT = 0; 
 nextQ();
}

// --- PATCH 1: HARD CRASH FIXES (nextQ logic) ---
function nextQ(){
 if(!CURRENT_SES_ID && SESSION_ALL.length > 0 && POOL.length <= SESSION_ALL.length){ generateSessionID(); }
 
 if(!POOL.length){ 
    if(WRONG.length > 0){ review(); return; } // Logic Fix
    report(); return; 
 }
 
 const d=POOL.shift();
 log(`ID: ${d.id}`, "normal");
 if(!SESSION_ALL.includes(d)) SESSION_ALL.push(d); 
 const opts = shuffle([d.u, d.l, d.r]);
 const map = { up: opts[0], left: opts[1], right: opts[2] };
 
 card(d.q, map, dir=>{
  let picked = null;
  if(dir==="UP") picked = map.up; if(dir==="LEFT") picked = map.left; if(dir==="RIGHT") picked = map.right;
  let c = d.correct; if(c==="UP"||c==="A") c=d.u; else if(c==="LEFT"||c==="B") c=d.l; else if(c==="RIGHT"||c==="R"||c==="C") c=d.r;
  const isCorrect = String(picked).trim().toLowerCase() === String(c).trim().toLowerCase();
  
  const latency = Date.now() - Q_START_TIME;
  
  // PATCH 4: LLM HOOK
  LLM_DECIDE({
      session_id: CURRENT_SES_ID,
      question_id: d.id,
      question: d.q,
      options: map,
      user_history: SESSION_LOG.slice(-5),
      latency
  });

  SESSION_LOG.push({ id: d.id, res: isCorrect ? "WIN" : "LOSS", latency: latency });

  if(!isCorrect){ WRONG.push(d); } else { if(!ATTEMPTED.has(d.id)){ XP+=1; } }
  ATTEMPTED.add(d.id);
  UI.xp.textContent=`${XP} / ${SESSION_ALL.length}`;
  UI.bar.style.width = ((SESSION_ALL.length - POOL.length) / SESSION_ALL.length) * 100 + "%";
  nextQ();
 });
}

function review(){
 if(!WRONG.length){ report(); return; } 
 const d=WRONG[0]; 
 log("REVIEW MODE", "primary");
 log(`HINT: ${d.hint ? "ACTIVE" : "NONE"}`, "active");
 card(`REVIEW NOTE\n\n${d.logic || "Review the core principles."}`,{up:"RETRY", down:"SKIP"},dir=>{
    if(dir==="UP"){ WRONG.shift(); POOL.unshift(d); } else { WRONG.shift(); }
    nextQ();
 });
}

function report(){
 if(!CURRENT_SES_ID) generateSessionID();
 const percent = Math.round((XP / SESSION_ALL.length) * 100) || 0;
 const statusText = USER_MOBILE ? `USER: ${USER_MOBILE}` : "GUEST (UNLINKED)";
 
 card(`SUMMARY\n\n${XP} / ${SESSION_ALL.length} Correct\n(${percent}%)\n\nID: ${CURRENT_SES_ID}\n${statusText}`,{down:"DOWNLOAD PDF", up:"RESTART", left:"MENU"},dir=>{
    if(dir==="DOWN") handleDownloadRequest();
    if(dir==="UP") startQuiz(); 
    if(dir==="LEFT") begin();
 }, false);
}

function handleDownloadRequest(){
    if(!USER_MOBILE){
        log("IDENTITY UNLINKED", "danger");
        const text = `REGISTERING ACCOUNT.\nLINK MY ID: ${CURRENT_SES_ID}`;
        const url = `https://wa.me/${WA_NUMBER}?text=${encodeURIComponent(text)}`;
        card(`ACCOUNT REQUIRED\n\nTo save this PDF, you must link your device.\n\nID: ${CURRENT_SES_ID}`,
            { up: "LINK VIA WHATSAPP", down: "I HAVE LINKED" },
            (dir) => {
                if(dir === "UP") { window.open(url, '_blank'); }
                if(dir === "DOWN") {
                    const mob = prompt("ENTER REGISTERED MOBILE (For PDF Stamping):\n\nEnter your mobile number here...");
                    if(mob && mob.length >= 10) {
                        localStorage.setItem("USER_MOBILE", mob); USER_MOBILE = mob;
                        log("IDENTITY LINKED", "active"); report();
                    } else { log("INVALID INPUT", "normal"); handleDownloadRequest(); }
                }
            }, false
        );
        return;
    }
    exportSessionPDF();
}

// --- PATCH 5: PDF DATA HANDLING ---
function exportSessionPDF(data=null, id=null){
 const renderData = Array.isArray(data) ? data : [...SESSION_ALL]; // Safety check
 const renderID = id || CURRENT_SES_ID;
 
 if(!data){ 
    if(CREDITS < 1) { log("INSUFFICIENT CREDITS", "danger"); return; }
    CREDITS--;
    localStorage.setItem("USER_CREDITS", CREDITS);
    VAULT.unshift({ id: renderID, date: new Date().toLocaleDateString(), score: XP, total: SESSION_ALL.length, data: [...SESSION_ALL] });
    localStorage.setItem("USER_VAULT", JSON.stringify(VAULT));
    log(`UNIT SPENT // BAL: ${CREDITS}`, "primary");
 }

 log("GENERATING PDF...", "active");
 const {jsPDF}=window.jspdf; const doc=new jsPDF();
 const unique=renderData.filter((q,i,self)=>i===self.findIndex(t=>(t.id===q.id)));
 let y=20; const ML=15; const W=180;
 const COL_OPT_W=45; const COL_LOG_W=65; const COL_EXE_W=65;
 const COL_LOG_X=ML+COL_OPT_W+5; const COL_EXE_X=COL_LOG_X+COL_LOG_W+5;

 doc.setFont("times","bold"); doc.setFontSize(16);
 doc.text(`VIA.STACK // ${renderID}`,105,y,{align:"center"});
 doc.setFontSize(10); doc.text(`USER: ${USER_MOBILE || "GUEST"}`, 105, y+5, {align:"center"});
 doc.line(ML,y+8,195,y+8); y+=15;

 unique.forEach((d,i)=>{
  if(y>240){doc.addPage();y=20;}
  doc.setFont("helvetica","bold"); doc.setFontSize(8); doc.setTextColor(100);
  doc.text(`${d.id} // ${d.dom||"GEN"}`,ML,y); y+=5;
  doc.setFont("times","bold"); doc.setFontSize(12); doc.setTextColor(0);
  const qLines = doc.splitTextToSize(cleanPDF(d.q),W); doc.text(qLines,ML,y); y+=(qLines.length*5)+3;
  doc.setDrawColor(200); doc.setLineWidth(0.1); doc.line(ML,y,195,y); y+=5;
  
  const startY=y;
  doc.setFont("helvetica","bold"); doc.setFontSize(7); doc.setTextColor(150); doc.text("OPTIONS",ML,y); y+=4;
  doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(80,80,80); 
  const optA=`(A) ${cleanPDF(d.u)}`; const optB=`(B) ${cleanPDF(d.l)}`; const optC=`(C) ${cleanPDF(d.r)}`;
  doc.text(doc.splitTextToSize(optA,COL_OPT_W),ML,y); y+=doc.splitTextToSize(optA,COL_OPT_W).length*4+2;
  doc.text(doc.splitTextToSize(optB,COL_OPT_W),ML,y); y+=doc.splitTextToSize(optB,COL_OPT_W).length*4+2;
  doc.text(doc.splitTextToSize(optC,COL_OPT_W),ML,y); y+=doc.splitTextToSize(optC,COL_OPT_W).length*4+2;
  
  let maxH=y; y=startY;
  doc.setFont("helvetica","bold"); doc.setFontSize(7); doc.setTextColor(150); doc.text("THEORY",COL_LOG_X,y); y+=4;
  doc.setFont("times","italic"); doc.setFontSize(9); doc.setTextColor(50);
  const logT=doc.splitTextToSize(cleanPDF(d.logic||"-"),COL_LOG_W); doc.text(logT,COL_LOG_X,y);
  if(y+(logT.length*4)>maxH) maxH=y+(logT.length*4);
  y=startY;
  
  doc.setFont("helvetica","bold"); doc.setFontSize(7); doc.setTextColor(150); doc.text("EXECUTION",COL_EXE_X,y); y+=4;
  doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(0);
  const s1=`1. ${cleanPDF(d.step1||"-")}`; const s2=`2. ${cleanPDF(d.step2||"-")}`;
  const s1L=doc.splitTextToSize(s1,COL_EXE_W); doc.text(s1L,COL_EXE_X,y); y+=(s1L.length*4)+2;
  const s2L=doc.splitTextToSize(s2,COL_EXE_W); doc.text(s2L,COL_EXE_X,y);
  if(y+(s2L.length*4)>maxH) maxH=y+(s2L.length*4);
  
  y=maxH+5;
  if(d.trap){
   doc.setLineDash([1,1],0); doc.line(ML,y,195,y); doc.setLineDash([]); y+=4;
   doc.setFont("helvetica","bold"); doc.setFontSize(7); doc.setTextColor(200,50,50); doc.text("TRAP:",ML,y);
   doc.setFont("times","italic"); doc.setTextColor(80); doc.text(cleanPDF(d.trap),ML+35,y); y+=8;
  } else {y+=5;}
  y+=5;
 });

 const fileName = `ALCHEMIST_${renderID}.pdf`;
 doc.save(fileName);

 // --- PATCH 6: TELEMETRY GUARD ---
 if(!data && !SES_BEACON_SENT) {
     SES_BEACON_SENT = true;
     sendTelemetry(); 
 }
 setTimeout(begin,500);
}

function sendTelemetry(sid) {
    if(!BEACON_URL) return;
    const totalLatency = SESSION_LOG.reduce((sum, item) => sum + item.latency, 0);
    const avgLatency = SESSION_LOG.length > 0 ? Math.round(totalLatency / SESSION_LOG.length) : 0;
    const accuracy = SESSION_ALL.length > 0 ? Math.round((XP / SESSION_ALL.length) * 100) : 0;

    log("UPLOADING SESSION...", "primary");
    
    fetch(BEACON_URL, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
            ses_id: CURRENT_SES_ID,
            mobile: USER_MOBILE || "GUEST",
            credits: CREDITS,
            score: XP,
            accuracy: accuracy,
            latency: avgLatency,
            pivots: PIVOT_COUNT,
            log: SESSION_LOG
        })
    }).then(() => {
        log("DATA SECURED", "active");
    }).catch(e => {
        log("DATA SYNC FAILED", "danger");
    });
}

function generateSessionID() {
    const hash = Math.random().toString(36).substring(2, 7).toUpperCase();
    CURRENT_SES_ID = `SES_${hash}`;
    localStorage.setItem("LAST_SES_ID", CURRENT_SES_ID);
    log(`SESSION HASH: ${CURRENT_SES_ID}`, "primary");
}

function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}
const cleanPDF = t => String(t||"").replace(/<[^>]*>/g, "").replace(/&Delta;/g, "Î”");

async function init() {
  log("SYSTEM BOOT", "active");
  pingAdmin();

  // Use INJECTED_DATA instead of fetching
  RAW_DATA = INJECTED_DATA.map(d => ({
    id: d.id,
    set: d.set || "DEFAULT",
    dom: d.dom || "GEN",
    topic: d.topic || "",
    q: d.q,
    u: d.u,
    l: d.l,
    r: d.r,
    correct: d.correct,
    logic: d.logic || "",
    hint: d.hint || "",
    trap: d.trap || "",
    step1: d.s1 || d.step1 || "",
    step2: d.s2 || d.step2 || ""
  })).filter(d => d.id); 

  log(`STATIC DATA LOADED (${RAW_DATA.length})`, "active");
  begin();
}
init();
</script>
</body>
</html>
